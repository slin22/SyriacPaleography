<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style> /* set the CSS */

body {
    background: linear-gradient(to top, #ffffcc 0%, #996633 36%); padding-right: 20px; padding-left: 20px; color: burlywood; font-family: Lucida;
}
h1 {
  font-family: Georgia; font-size: 300%; color: wheat;
}
input {
  border:1px;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}

img {
  border: 1px;
  border-radius: 4px;
  padding: 5px;
  height: 250px;
  width: 150px;
}
img:hover {
  box-shadow: 0 0 2px 1px rgb(255,235,205);
  
}

</style>

<link rel="stylesheet" href="src/css/swipebox.css">

<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
 -->  <!-- load the d3.js library -->    
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="lib/jquery-2.1.0.min.js"></script>
<script src="src/js/jquery.swipebox.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">



</head>
<body>

<h1>Syriac Manuscripts</h1>
<h4>

Choose a file name or a date range
<br>
File name will update with date range
<br>
<br>
<label for="myinput">File name: </label>
<input class="ui-widget" id="myinput" name="filename">
<button id="submitButton">Submit</button>
<br>

<br>
From <input id="min" name="min">

To <input id="max" type="number" name="max">
<button id="submitdatebutton"/>Submit</button>

<br>
<br>
<hr>
</h4>
<script>

function append(input) {
  var URL = "getData.php?filename="+input;

// get the data from getData.php and store it as 'data'

  d3.json(URL, function(error, data) {
    if (error) {
      console.log("Something went wrong...");
      throw error;
    }

  /* 
    For the purpose of creating only one thumbnail for each manuscript, only the first page of a manuscript will be displayed as a thumbnail. Use a 'pages' array to store all the pages that have the same manuscript number (manuscript name). Use a nested array 'manuscripts' to then store all the pages that have already been grouped by manuscript number.
  */

    var manuscripts = [];
    var pages = [];
    var last_manuscript = data[0];
    var manuscript_count = 0;
    var temp_count = 15;

    data.forEach(function(manuscript_page) {

      if (manuscript_page.Manuscript_No != last_manuscript.Manuscript_No && manuscript_count < temp_count) {
        manuscripts.push(pages);
        manuscript_count += 1;
        pages = [];
        pages.push(manuscript_page);
        last_manuscript = manuscript_page;
      }
      else{
        pages.push(manuscript_page);
        last_manuscript = manuscript_page;
      }

    });

    manuscripts.push(pages);

  });
}

function appendImages(input) {

// URL for getData from input
// counter variable for grouping images

  var counter = 1;
  var URL = "getData.php?filename="+input;

// get the data from getData.php and store it as 'data'

  d3.json(URL, function(error, data) {
    if (error) {
       console.log("Something went wrong...");
       throw error;
    }

  /* 
    For the purpose of creating only one thumbnail for each manuscript, only the first page of a manuscript will be displayed as a thumbnail. Use a 'pages' array to store all the pages that have the same manuscript number (manuscript name). Use a nested array 'manuscripts' to then store all the pages that have already been grouped by manuscript number.
  */

    var manuscripts = [];
    var pages = [];
    var last_manuscript = data[0];
    var manuscript_count = 0;

    data.forEach(function(manuscript_page) {

      if (manuscript_page.Manuscript_No != last_manuscript.Manuscript_No) {
    		manuscripts.push(pages);
        manuscript_count += 1;
    		pages = [];
    		pages.push(manuscript_page);
    		last_manuscript = manuscript_page;
      }
      else{
    		pages.push(manuscript_page);
    		last_manuscript = manuscript_page;
      }

    });
      manuscripts.push(pages);
  




    /*
      For each of the manuscripts in the nested array 'manuscripts', loop through each page of the manuscript and create swipebox images of each, categorizing them by manuscript number using 'gallery-'+counter.
    */

  manuscripts.forEach(function(array) {
    for (var i=0; i < array.length; i++) {
	    	var manuscript = array[i];
	      var a = document.createElement("a");
	      a.setAttribute("href", manuscript.Image_Name);
	      a.setAttribute("target", "_blank"); 
	      a.setAttribute("class", "swipebox");
	      a.setAttribute("title", manuscript.Manuscript_No + " " + manuscript.Page_No);
	      a.setAttribute("rel", "gallery-"+counter);

	      if (i != 0) {
	        var x = document.createElement("IMG");
	        x.setAttribute("src", manuscript.Image_Name);
	        x.setAttribute("width", "100");
	        x.setAttribute("style", "display: none;");

	      }
	      else {
	        var x = document.createElement("IMG");
	        x.setAttribute("src", manuscript.Image_Name);
	        x.setAttribute("width", "100");
	        x.setAttribute("title", manuscript.Page_No);
	      }

	      a.appendChild(x);
	      d3.select("body").append(function(){return a});

    }

    counter += 1;

  });
  });

};


//getAvailableTags function for autocomplete feature in search bar.

function getAvailableTags(input1, input2) {
d3.json("getFullData.php?min="+input1+"&max="+input2, function(error, data2) {
    if (error) {
       console.log("Something went wrong...");
       throw error;
    }
  var availableTags = [];
  var tagWithDates = [];
  
  var last__manuscript = data2[0];
  availableTags.push(last__manuscript);
    data2.forEach(function(d) {
      if (d.Manuscript_No != last__manuscript.Manuscript_No) {
        availableTags.push(d.Manuscript_No);
        tagWithDates.push(d.Date);
        last__manuscript = d;
      }
});

function split( val ) {
      return val.split( /,\s*/ );
    }
function extractLast( term ) {
      return split( term ).pop();
    }
$( "#myinput" )
      .on( "keydown", function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB &&
            $( this ).autocomplete( "instance" ).menu.active ) {
          event.preventDefault();
        }
      })
      .autocomplete({
        minLength: 0,
        source: function( request, response ) {
          response( $.ui.autocomplete.filter(
            availableTags, extractLast( request.term ) ) );
        },
        focus: function() {
          return false;
        },
        select: function( event, ui ) {
          var terms = split( this.value );
          terms.pop();
          terms.push( ui.item.value );
          terms.push( "" );
          this.value = terms.join( ", " );
          return false;
        }
      });
});
};
d3.select('#submitdatebutton').on('click', function(){
  var input1 = $("#min").val()
  var input2 = $("#max").val()
  getAvailableTags(input1, input2);
});
  $( '.swipebox' ).swipebox();
d3.select('#submitButton').on('click', function() {
    $(".swipebox").remove();
    var input = $("#myinput").val()
    appendImages(input);
});
 appendImages('');
d3.json("getFullData.php?", function(error, data2) {
    if (error) {
       console.log("Something went wrong...");
       throw error;
    }
  var availableTags = [];
  var tagWithDates = [];
  
  var last__manuscript = data2[0];
  availableTags.push(last__manuscript);
    data2.forEach(function(d) {
      if (d.Manuscript_No != last__manuscript.Manuscript_No) {
        availableTags.push(d.Manuscript_No);
        tagWithDates.push(d.Date);
        last__manuscript = d;
      }
});

function split( val ) {
      return val.split( /,\s*/ );
    }
function extractLast( term ) {
      return split( term ).pop();
    }
$( "#myinput" )
      .on( "keydown", function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB &&
            $( this ).autocomplete( "instance" ).menu.active ) {
          event.preventDefault();
        }
      })
      .autocomplete({
        minLength: 0,
        source: function( request, response ) {
          response( $.ui.autocomplete.filter(
            availableTags, extractLast( request.term ) ) );
        },
        focus: function() {
          return false;
        },
        select: function( event, ui ) {
          var terms = split( this.value );
          terms.pop();
          terms.push( ui.item.value );
          terms.push( "" );
          this.value = terms.join( ", " );
          return false;
        }
      });
});

</script>

<button id="next_page" onclick="append('')">Next Page</button>

</body>

</html>
